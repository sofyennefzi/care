{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}
{% block page_title %}Tableau de bord{% endblock %}

{% block extra_css %}
<style>
  .card-patients {
    background-color: #f8fafc;
    border-left: 4px solid #3b82f6;
    border-radius: 8px;
  }

  .card-passes {
    background-color: #f0fdf4;
    border-left: 4px solid #22c55e;
    border-radius: 8px;
  }

  .card-futurs {
    background-color: #fefce8;
    border-left: 4px solid #eab308;
    border-radius: 8px;
  }

  .card-caisse {
    background-color: #f3e8ff;
    border-left: 4px solid #8b5cf6;
    border-radius: 8px;
  }

  .revenue-card {
    background-color: #ecfdf5;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
  }

  .status-card {
    background-color: #fef3c7;
    border: 1px solid #fed7aa;
    border-radius: 8px;
  }

  .chart-card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .chart-header-blue {
    background-color: #dbeafe;
    border-bottom: 1px solid #93c5fd;
    color: #1e40af;
  }

  .chart-header-green {
    background-color: #dcfce7;
    border-bottom: 1px solid #86efac;
    color: #15803d;
  }

  .page-header {
    background-color: #f1f5f9;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Simple Page Header -->
  <div class="page-header">
    <h1 class="mb-2 text-slate-700">
      <i class="bi bi-speedometer2 me-2 text-blue-600"></i>
      Tableau de Bord
    </h1>
    <p class="mb-0 text-muted">
      {{ "now"|format_date }} • Vue d'ensemble de votre clinique
    </p>
  </div>

  <!-- Simple KPI Cards -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card card-patients">
        <div class="card-body text-center py-3">
          <i class="bi bi-people-fill text-blue-600 mb-2" style="font-size: 2rem;"></i>
          <h3 class="mb-1 text-blue-800">{{ stats.total_patients }}</h3>
          <div class="text-blue-700">Patients</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card card-passes">
        <div class="card-body text-center py-3">
          <i class="bi bi-calendar-check-fill text-green-600 mb-2" style="font-size: 2rem;"></i>
          <h3 class="mb-1 text-green-800">{{ stats.rdv_passes }}</h3>
          <div class="text-green-700">RDV Passés</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card card-futurs">
        <div class="card-body text-center py-3">
          <i class="bi bi-calendar-plus-fill text-yellow-600 mb-2" style="font-size: 2rem;"></i>
          <h3 class="mb-1 text-yellow-800">{{ stats.rdv_futurs }}</h3>
          <div class="text-yellow-700">RDV Futurs</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card card-caisse">
        <div class="card-body text-center py-3">
          <i class="bi bi-wallet2 text-purple-600 mb-2" style="font-size: 2rem;"></i>
          <h3 class="mb-1 text-purple-800">{{ stats.caisse_jour | format_currency }}</h3>
          <div class="text-purple-700">Caisse du Jour</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Simple Revenue Summary -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-8">
      <div class="card revenue-card">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <i class="bi bi-cash-stack text-green-600 me-3" style="font-size: 2.5rem;"></i>
            <div>
              <h6 class="mb-1 text-green-700">Revenu Total Encaissé</h6>
              <h2 class="mb-0 text-green-800">{{ stats.revenu_total | format_currency }}</h2>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card status-card">
        <div class="card-body">
          <h6 class="mb-3 text-amber-700">État des RDV</h6>
          <div class="mb-2">
            <span class="badge bg-success me-2">Validés</span>
            <strong>{{ stats.repartition_etat.valide }}</strong>
          </div>
          <div class="mb-2">
            <span class="badge bg-warning me-2">En attente</span>
            <strong>{{ stats.repartition_etat.en_attente }}</strong>
          </div>
          <div>
            <span class="badge bg-danger me-2">Annulés</span>
            <strong>{{ stats.repartition_etat.annule }}</strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Simple Analytics Charts -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-xl-8">
      <div class="card chart-card">
        <div class="card-header chart-header-blue">
          <h5 class="mb-0">
            <i class="bi bi-bar-chart-fill me-2"></i>
            RDV par jour de la semaine
          </h5>
        </div>
        <div class="card-body">
          <div style="position:relative;height:400px;">
            <canvas id="rdvParJourChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4">
      <div class="card chart-card">
        <div class="card-header chart-header-green">
          <h5 class="mb-0">
            <i class="bi bi-pie-chart-fill me-2"></i>
            Top 5 services populaires
          </h5>
        </div>
        <div class="card-body">
          <div style="position:relative;height:400px;">
            <canvas id="topServicesChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing charts...');

    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.color = '#6b7280';

    // RDV par jour - Bar Chart with simple blue color
    const rdvParJourCtx = document.getElementById('rdvParJourChart');
    if (rdvParJourCtx) {
      console.log('Found rdvParJourChart canvas element');

      const rdvParJourData = {{ stats.rdv_par_jour | tojson | safe }};
      console.log('RDV par jour data received:', rdvParJourData);

      const labels = Object.keys(rdvParJourData);
      const values = Object.values(rdvParJourData).map(v => Number(v) || 0);

      console.log('Chart labels:', labels);
      console.log('Chart values:', values);

      try {
        const chart = new Chart(rdvParJourCtx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Nombre de RDV',
              data: values,
              backgroundColor: '#3b82f6',
              borderRadius: 4,
              borderWidth: 0,
              hoverBackgroundColor: '#2563eb'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(59, 130, 246, 0.9)',
                titleColor: '#fff',
                bodyColor: '#fff',
                cornerRadius: 6
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  color: '#6b7280'
                },
                grid: {
                  color: 'rgba(107, 114, 128, 0.1)',
                  drawBorder: false
                }
              },
              x: {
                ticks: {
                  color: '#6b7280'
                },
                grid: { display: false }
              }
            }
          }
        });
        console.log('✅ Bar chart created successfully');
      } catch (error) {
        console.error('❌ Error creating bar chart:', error);
      }
    } else {
      console.error('❌ rdvParJourChart canvas element not found');
    }

    // Top Services - Donut Chart with simple colors
    const topServicesCtx = document.getElementById('topServicesChart');
    if (topServicesCtx) {
      console.log('Found topServicesChart canvas element');

      const topServices = {{ stats.top_services | tojson | safe }};
      console.log('Top services data received:', topServices);

      if (topServices && Array.isArray(topServices) && topServices.length > 0) {
        try {
          const chart = new Chart(topServicesCtx, {
            type: 'doughnut',
            data: {
              labels: topServices.map(s => s.nom),
              datasets: [{
                data: topServices.map(s => s.count),
                backgroundColor: [
                  '#3b82f6', // Blue
                  '#22c55e', // Green
                  '#eab308', // Yellow
                  '#ef4444', // Red
                  '#8b5cf6', // Purple
                  '#06b6d4', // Cyan
                  '#f97316'  // Orange
                ],
                borderWidth: 3,
                borderColor: '#fff',
                hoverOffset: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    padding: 15,
                    usePointStyle: true,
                    font: { size: 12 },
                    color: '#6b7280'
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(75, 85, 99, 0.9)',
                  titleColor: '#fff',
                  bodyColor: '#fff',
                  cornerRadius: 6,
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.parsed || 0;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((value / total) * 100).toFixed(1);
                      return `${label}: ${value} RDV (${percentage}%)`;
                    }
                  }
                }
              }
            }
          });
          console.log('✅ Donut chart created successfully');
        } catch (error) {
          console.error('❌ Error creating donut chart:', error);
        }
      } else {
        console.log('⚠️ No services data available, showing empty state');
        topServicesCtx.parentElement.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-pie-chart text-muted" style="font-size: 64px; opacity: 0.3;"></i>
            <h5 class="text-muted mt-3">Aucun service utilisé</h5>
            <p class="text-muted">Les services populaires apparaîtront ici</p>
          </div>
        `;
      }
    } else {
      console.error('❌ topServicesChart canvas element not found');
    }
  });
</script>
{% endblock %}
