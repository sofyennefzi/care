{% extends "base.html" %}

{% block title %}Aujourd'hui - Gestion Clinique{% endblock %}

{% block page_title %}Aujourd'hui{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <!-- Hero Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4); overflow: hidden; position: relative;">
                <div class="card-body py-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center gap-3 mb-3">
                                <div style="width: 72px; height: 72px; background: rgba(255, 255, 255, 0.25); border-radius: 16px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.3);">
                                    <i class="bi bi-hospital" style="font-size: 36px; color: white;"></i>
                                </div>
                                <div class="text-white">
                                    <h2 class="mb-1" style="font-weight: 800; font-size: 28px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Dr. Clinique Dentaire</h2>
                                    <p class="mb-1" style="opacity: 0.95; font-size: 15px; font-weight: 500;">
                                        <i class="bi bi-geo-alt-fill me-1"></i> Spécialiste en Soins Dentaires Complets
                                    </p>
                                    <p class="mb-0" style="opacity: 0.9; font-size: 14px; font-weight: 500;">
                                        <i class="bi bi-telephone-fill me-1"></i> +216 55 934 066
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-white text-md-end">
                                <div style="display: inline-block; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); padding: 20px 32px; border-radius: 16px; border: 2px solid rgba(255, 255, 255, 0.3);">
                                    <h3 class="mb-1" style="font-weight: 800; font-size: 42px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">{{ appointments|length }}</h3>
                                    <p class="mb-0" style="opacity: 0.95; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">RDV Aujourd'hui</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="position: absolute; right: -50px; top: -50px; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; filter: blur(40px);"></div>
                <div style="position: absolute; left: -30px; bottom: -30px; width: 150px; height: 150px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; filter: blur(30px);"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Services Section -->
        <div class="col-lg-9 mb-4">
            <div class="mb-4">
                <h4 class="mb-3" style="font-weight: 700; font-size: 20px; color: var(--text-primary);">
                    <i class="bi bi-heart-pulse-fill me-2 text-primary"></i>
                    Nos Services Principaux
                </h4>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card hover-lift" style="border: 2px solid rgba(37, 99, 235, 0.15); background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(30, 64, 175, 0.05)); height: 100%; transition: all 0.3s ease;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3" style="width: 64px; height: 64px; background: linear-gradient(135deg, #2563eb, #1e40af); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);">
                                    <i class="bi bi-heart-pulse-fill" style="font-size: 32px; color: white;"></i>
                                </div>
                                <h5 class="mb-2" style="font-weight: 700; color: var(--text-primary);">Soins généraux</h5>
                                <p class="text-muted mb-0" style="font-size: 13px; font-weight: 500;">Consultations et traitements dentaires courants</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card hover-lift" style="border: 2px solid rgba(16, 185, 129, 0.15); background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); height: 100%; transition: all 0.3s ease;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3" style="width: 64px; height: 64px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);">
                                    <i class="bi bi-gear-fill" style="font-size: 32px; color: white;"></i>
                                </div>
                                <h5 class="mb-2" style="font-weight: 700; color: var(--text-primary);">Implants dentaires</h5>
                                <p class="text-muted mb-0" style="font-size: 13px; font-weight: 500;">Solutions permanentes pour dents manquantes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card hover-lift" style="border: 2px solid rgba(239, 68, 68, 0.15); background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(220, 38, 38, 0.05)); height: 100%; transition: all 0.3s ease;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3" style="width: 64px; height: 64px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);">
                                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 32px; color: white;"></i>
                                </div>
                                <h5 class="mb-2" style="font-weight: 700; color: var(--text-primary);">Urgences dentaires</h5>
                                <p class="text-muted mb-0" style="font-size: 13px; font-weight: 500;">Interventions rapides 24/7</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Appointments Table -->
            <div class="card" style="border: 1px solid rgba(226, 232, 240, 0.8);">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.8)); border-bottom: 2px solid #e2e8f0;">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0" style="font-weight: 700; font-size: 18px; color: var(--text-primary);">
                            <i class="bi bi-calendar-check-fill me-2 text-primary"></i>
                            Rendez-vous du Jour
                        </h5>
                        <span class="badge bg-primary" style="font-size: 13px; padding: 8px 14px;">{{ appointments|length }} RDV</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">Heure</th>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Service</th>
                                    <th style="width: 120px;">État</th>
                                    <th style="width: 200px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for appt in appointments %}
                                <tr>
                                    <td>
                                        <div style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(30, 64, 175, 0.1)); padding: 8px 12px; border-radius: 8px; display: inline-block; border: 1px solid rgba(37, 99, 235, 0.2);">
                                            <i class="bi bi-clock-fill me-1 text-primary" style="font-size: 12px;"></i>
                                            <strong style="font-weight: 700; color: var(--text-primary);">{{ appt.heure | format_time }}</strong>
                                        </div>
                                    </td>
                                    <td style="font-weight: 600; color: var(--text-primary);">{{ appt.patient.nom }}</td>
                                    <td style="font-weight: 600; color: var(--text-primary);">{{ appt.patient.prenom }}</td>
                                    <td>
                                        <span style="color: var(--text-secondary); font-weight: 500;">{{ appt.service.nom }}</span>
                                    </td>
                                    <td>
                                        {% if appt.etat.value == 'en_attente' %}
                                        <span class="badge bg-warning" style="font-size: 12px; padding: 7px 12px;">
                                            <i class="bi bi-clock-fill me-1"></i>En attente
                                        </span>
                                        {% elif appt.etat.value == 'valide' %}
                                        <span class="badge bg-success" style="font-size: 12px; padding: 7px 12px;">
                                            <i class="bi bi-check-circle-fill me-1"></i>Validé
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger" style="font-size: 12px; padding: 7px 12px;">
                                            <i class="bi bi-x-circle-fill me-1"></i>Annulé
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group-actions">
                                            {% if appt.etat.value == 'en_attente' %}
                                            <button class="btn btn-sm btn-success" onclick="validateAppointment({{ appt.id }})" style="font-weight: 600;">
                                                <i class="bi bi-check-circle"></i> Valider
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-info" onclick="viewDetails({{ appt.id }})" style="font-weight: 600;">
                                                <i class="bi bi-eye"></i> Détails
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="empty-state">
                                            <i class="bi bi-calendar-x" style="font-size: 64px; color: var(--text-light); opacity: 0.4; display: block; margin-bottom: 16px;"></i>
                                            <h5 style="color: var(--text-secondary); font-weight: 600;">Aucun rendez-vous aujourd'hui</h5>
                                            <p style="color: var(--text-light); font-size: 14px; margin-top: 8px;">Profitez de cette journée tranquille!</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mini Calendar -->
        <div class="col-lg-3">
            <div class="card" style="border: 1px solid rgba(226, 232, 240, 0.8); position: sticky; top: 100px;">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(30, 64, 175, 0.08)); border-bottom: 2px solid rgba(37, 99, 235, 0.15);">
                    <h5 class="mb-0 text-center" style="font-weight: 700; font-size: 16px; color: var(--text-primary);">
                        <i class="bi bi-calendar3 me-2 text-primary"></i>
                        Calendrier
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div id="miniCalendar"></div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card mt-3" style="border: 1px solid rgba(226, 232, 240, 0.8);">
                <div class="card-body p-3">
                    <h6 class="mb-3" style="font-weight: 700; font-size: 14px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px;">
                        Statistiques Rapides
                    </h6>
                    <div class="d-flex align-items-center justify-content-between mb-3 p-2" style="background: rgba(16, 185, 129, 0.08); border-radius: 10px; border-left: 3px solid #10b981;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase;">Validés</div>
                            <div style="font-size: 20px; font-weight: 800; color: #10b981;">
                                {{ appointments | selectattr('etat.value', 'equalto', 'valide') | list | length }}
                            </div>
                        </div>
                        <i class="bi bi-check-circle-fill" style="font-size: 28px; color: #10b981; opacity: 0.5;"></i>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mb-3 p-2" style="background: rgba(245, 158, 11, 0.08); border-radius: 10px; border-left: 3px solid #f59e0b;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase;">En Attente</div>
                            <div style="font-size: 20px; font-weight: 800; color: #f59e0b;">
                                {{ appointments | selectattr('etat.value', 'equalto', 'en_attente') | list | length }}
                            </div>
                        </div>
                        <i class="bi bi-clock-fill" style="font-size: 28px; color: #f59e0b; opacity: 0.5;"></i>
                    </div>
                    <div class="d-flex align-items-center justify-content-between p-2" style="background: rgba(239, 68, 68, 0.08); border-radius: 10px; border-left: 3px solid #ef4444;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase;">Annulés</div>
                            <div style="font-size: 20px; font-weight: 800; color: #ef4444;">
                                {{ appointments | selectattr('etat.value', 'equalto', 'annule') | list | length }}
                            </div>
                        </div>
                        <i class="bi bi-x-circle-fill" style="font-size: 28px; color: #ef4444; opacity: 0.5;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Professional mini calendar with enhanced styling
    function createMiniCalendar() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                           'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

        let html = `<div class="text-center mb-3" style="padding: 12px; background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(30, 64, 175, 0.08)); border-radius: 10px;">
                        <strong style="font-size: 15px; font-weight: 700; color: var(--text-primary);">${monthNames[month]} ${year}</strong>
                    </div>`;
        html += '<table class="table table-sm table-borderless mb-0" style="font-size: 13px;"><thead><tr>';

        const dayNames = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
        dayNames.forEach(day => {
            html += `<th class="text-center" style="font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; padding: 8px 4px;">${day}</th>`;
        });
        html += '</tr></thead><tbody><tr>';

        // Empty cells before first day
        for (let i = 0; i < firstDay; i++) {
            html += '<td></td>';
        }

        // Days with enhanced styling
        for (let day = 1; day <= daysInMonth; day++) {
            if ((firstDay + day - 1) % 7 === 0 && day !== 1) {
                html += '</tr><tr>';
            }

            const isToday = (day === now.getDate());
            const todayStyle = isToday
                ? 'background: linear-gradient(135deg, #2563eb, #1e40af); color: white; font-weight: 800; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);'
                : 'color: var(--text-primary); font-weight: 600; background: transparent;';
            const hoverStyle = !isToday ? 'onmouseover="this.style.background=\'rgba(37, 99, 235, 0.1)\'; this.style.transform=\'scale(1.1)\';" onmouseout="this.style.background=\'transparent\'; this.style.transform=\'scale(1)\';"' : '';

            html += `<td class="text-center" style="border-radius: 8px; padding: 8px 4px; ${todayStyle} transition: all 0.2s ease; cursor: pointer;" ${hoverStyle}>${day}</td>`;
        }

        html += '</tr></tbody></table>';
        document.getElementById('miniCalendar').innerHTML = html;
    }

    createMiniCalendar();

    function validateAppointment(id) {
        if (!confirm('Êtes-vous sûr de vouloir valider ce rendez-vous ?')) return;

        fetch(`/api/rdv/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ etat: 'valide' })
        })
        .then(response => {
            if (!response.ok) throw new Error('Erreur réseau');
            return response.json();
        })
        .then(data => {
            showToast('✓ Rendez-vous validé avec succès', 'success');
            setTimeout(() => location.reload(), 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('✗ Erreur lors de la validation', 'error');
        });
    }

    function viewDetails(id) {
        window.location.href = `/rdv?highlight=${id}`;
    }
</script>
{% endblock %}

